# Инструкция по тестированию модального окна оборудования

## Что было переделано

Модальное окно для добавления и редактирования оборудования полностью переработано:

1. **Упрощенный дизайн** - убраны сложные CSS анимации и transition
2. **Простой JavaScript** - использован базовый onclick обработчик вместо сложного Stimulus контроллера
3. **Работающий пример** - реализовано по аналогии с модальным окном в разделе Ремонт
4. **bg-opacity-50** - использован требуемый класс Tailwind для полупрозрачного фона

## Как тестировать

### 1. Добавление нового оборудования

1. Перейти на страницу одного из разделов:
   - **CUTE**: http://127.0.0.1:3000/cute_equipments
   - **FIDS**: http://127.0.0.1:3000/fids_equipments
   - **ZAMAR**: http://127.0.0.1:3000/zamar_equipments

2. Нажать кнопку **"Добавить оборудование"**

**Ожидаемый результат:**
- Модальное окно открывается по центру экрана
- Фон затемняется (bg-opacity-50)
- Окно содержит форму для добавления оборудования
- Нет никаких анимаций, окно открывается мгновенно

### 2. Редактирование существующего оборудования

1. В таблице оборудования найти оборудование
2. Нажать на иконку редактирования (карандаш) в колонке "Действия"

**Ожидаемый результат:**
- Модальное окно открывается с заполненной формой
- Видны все текущие значения оборудования
- Поле "Место установки" содержит текущее привязанное место (если есть)

### 3. Закрытие модального окна

Модальное окно можно закрыть несколькими способами:

#### Способ 1: Кнопка закрытия (X)
- Нажать на кнопку X в правом верхнем углу

#### Способ 2: Кнопка "Отменить"
- Нажать на кнопку "Отменить" в форме

#### Способ 3: Клавиша Escape
- Нажать клавишу Escape на клавиатуре

#### Способ 4: Клик вне модального окна
- Кликнуть на затемненный фон вне окна

**Ожидаемый результат:**
- Модальное окно закрывается
- Фон становится прозрачным
- Содержимое модального окна очищается
- Прокрутка страницы становится доступной

### 4. Сохранение оборудования

1. Заполнить или отредактировать поля формы
2. Нажать кнопку **"Добавить оборудование"** или **"Сохранить изменения"**

**Ожидаемый результат:**
- Форма отправляется на сервер
- После успешного сохранения модальное окно автоматически закрывается
- Таблица обновляется (для добавления - новая строка появляется; для редактирования - строка обновляется)
- Страница остается на той же странице (нет редиректа)

### 5. Ошибки валидации

1. Попробовать сохранить форму без обязательных полей
2. Или ввести невалидные данные

**Ожидаемый результат:**
- Модальное окно остается открытым
- Под заголовком появляется блок с ошибками в красном стиле
- Ошибки перечислены списком
- Пользователь может исправить ошибки и попробовать снова

## Структура реализации

### Файлы, которые были обновлены

1. **app/views/shared/_equipment_modal.html.erb**
   - Новая простая структура модального окна
   - JavaScript функции openEquipmentModal() и closeEquipmentModal()
   - Обработчики для Escape, клика вне окна и автоматического закрытия

2. **app/views/shared/_equipment_modal_form.html.erb**
   - Форма с кнопкой "Отменить", вызывающей closeEquipmentModal()

3. **app/javascript/controllers/modal_controller.js**
   - Упрощенный Stimulus контроллер
   - Слушает turbo:load и открывает модальное окно

4. **app/views/cute_equipments/index.html.erb**
5. **app/views/fids_equipments/index.html.erb**
6. **app/views/zamar_equipments/index.html.erb**
   - Кнопка добавления и редактирования обновлены
   - Добавлен onclick обработчик openEquipmentModal()

## Технические детали

### Как работает открытие модального окна

```html
<a href="/cute_equipments/new?format=turbo_stream" 
   onclick="openEquipmentModal(); return false;"
   data-turbo-frame="equipment-modal-frame">
  Добавить оборудование
</a>
```

1. `onclick="openEquipmentModal()"` - открывает модальное окно
2. `return false` - отменяет стандартное поведение ссылки
3. `data-turbo-frame="equipment-modal-frame"` - указывает Turbo загрузить содержимое в этот фрейм
4. Страница загружает содержимое через Turbo без перезагрузки

### Как работает закрытие модального окна

```javascript
function closeEquipmentModal() {
  document.getElementById('equipment-modal').classList.add('hidden');
  document.body.style.overflow = 'auto';
  const frame = document.querySelector('turbo-frame#equipment-modal-frame');
  if (frame) {
    frame.innerHTML = '';
  }
}
```

1. Скрывает модальное окно (добавляет класс `hidden`)
2. Восстанавливает прокрутку страницы
3. Очищает содержимое Turbo Frame

### Автоматическое закрытие после сохранения

Когда контроллер отправляет успешный Turbo Stream ответ, он очищает содержимое frame:

```ruby
turbo_stream.replace("equipment-modal-frame", "")
```

JavaScript слушает это событие и закрывает окно:

```javascript
document.querySelector('turbo-frame#equipment-modal-frame').addEventListener('turbo:load', function(e) {
  if (!e.target.innerHTML.trim()) {
    closeEquipmentModal();
  }
});
```

## Возможные проблемы и решения

### Проблема: Модальное окно не открывается

**Решение:**
1. Проверить консоль браузера (F12) на наличие JavaScript ошибок
2. Убедиться, что функция openEquipmentModal() доступна (она определена в _equipment_modal.html.erb)
3. Проверить, что Turbo Frame `equipment-modal-frame` присутствует в modal.html.erb

### Проблема: Модальное окно закрывается сразу после открытия

**Решение:**
1. Проверить, что в контроллере format.turbo_stream возвращает форму, а не пустую строку
2. Убедиться, что format.turbo_stream находится в действии new/edit

### Проблема: Форма не отправляется

**Решение:**
1. Проверить консоль браузера на ошибки
2. Убедиться, что Turbo Frame имеет правильный id: `equipment-modal-frame`
3. Проверить, что форма использует `form_with` с правильным URL

## Отличия от старой реализации

| Параметр | Старая версия | Новая версия |
|----------|---------------|-------------|
| Анимация открытия | Fade in + Scale | Мгновенное открытие |
| Управление JS | Сложный Stimulus контроллер | Простой onclick обработчик |
| CSS transitions | 300ms для opacity и transform | Нет транзиций |
| Фон | bg-gray-500 bg-opacity-75 | bg-gray-600 bg-opacity-50 |
| Обработчики | data-action в HTML | onclick в атрибуте |
| Открытие окна | turbo:load событие | Простой onclick |

## Заключение

Новая реализация модального окна:
- ✅ Простая и понятная
- ✅ Без сложных анимаций
- ✅ Работает надежно
- ✅ Использует bg-opacity-50 как требовалось
- ✅ По аналогии с разделом Ремонт
- ✅ Легко поддерживать и расширять
