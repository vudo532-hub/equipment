<div class="max-w-4xl mx-auto">
  <!-- Header -->
  <div class="mb-6">
    <nav class="flex mb-4" aria-label="Breadcrumb">
      <ol class="flex items-center space-x-2">
        <li><%= link_to "Места установки CUTE", cute_installations_path, class: "text-gray-500 hover:text-gray-700" %></li>
        <li class="flex items-center">
          <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
          </svg>
          <span class="ml-2 text-gray-700"><%= @installation.name %></span>
        </li>
      </ol>
    </nav>
    <div class="flex justify-between items-start">
      <div>
        <h1 class="text-2xl font-bold text-gray-900"><%= @installation.name %></h1>
        <p class="mt-1 text-sm text-gray-600">Карточка места установки</p>
      </div>
      <div class="flex space-x-3">
        <%= link_to edit_cute_installation_path(@installation), class: "inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50" do %>
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
          </svg>
          Редактировать
        <% end %>
        <% if can_delete? %>
          <%= link_to cute_installation_path(@installation),
              data: { turbo_method: :delete, turbo_confirm: "Вы уверены?" },
              class: "inline-flex items-center px-4 py-2 border border-red-300 rounded-md shadow-sm text-sm font-medium text-red-700 bg-white hover:bg-red-50" do %>
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
            Удалить
          <% end %>
        <% else %>
          <%= link_to "#",
              onclick: "alert('Удаление недоступно для вашей роли'); return false;",
              class: "inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-400 bg-gray-100 cursor-not-allowed" do %>
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
            Удалить
          <% end %>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Info Card -->
  <div class="bg-white shadow rounded-lg mb-6">
    <div class="px-4 py-5 sm:p-6">
      <dl class="grid grid-cols-1 sm:grid-cols-2" style="gap: 16px;">
        <div>
          <dt class="text-sm font-medium text-gray-500">Название</dt>
          <dd class="mt-1 text-sm text-gray-900"><%= @installation.name %></dd>
        </div>
        <div>
          <dt class="text-sm font-medium text-gray-500">Терминал</dt>
          <dd class="mt-1">
            <% if @installation.terminal.present? %>
              <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                <%= @installation.terminal_name %>
              </span>
            <% else %>
              <span class="text-gray-400">—</span>
            <% end %>
          </dd>
        </div>
        <div>
          <dt class="text-sm font-medium text-gray-500">Тип места</dt>
          <dd class="mt-1">
            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
              <%= @installation.installation_type %>
            </span>
          </dd>
        </div>
        <div>
          <dt class="text-sm font-medium text-gray-500">Идентификатор</dt>
          <dd class="mt-1 text-sm text-gray-900"><%= @installation.identifier || "—" %></dd>
        </div>
        <div>
          <dt class="text-sm font-medium text-gray-500">Количество оборудования</dt>
          <dd class="mt-1 text-sm text-gray-900"><%= @installation.equipment_count %> шт.</dd>
        </div>
        <div>
          <dt class="text-sm font-medium text-gray-500">Создано</dt>
          <dd class="mt-1 text-sm text-gray-900"><%= l(@installation.created_at, format: :long) %></dd>
        </div>
      </dl>
    </div>
  </div>

  <!-- Equipment List -->
  <div class="bg-white shadow rounded-lg">
    <div class="px-4 py-5 sm:p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-medium text-gray-900">Оборудование на этом месте</h3>
        <div class="flex space-x-2">
          <button type="button" 
                  onclick="openAssignEquipmentModal()"
                  class="inline-flex items-center px-3 py-1.5 border border-blue-600 text-sm font-medium rounded-md text-blue-600 bg-white hover:bg-blue-50">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
            </svg>
            Привязать
          </button>
          <%= link_to new_cute_equipment_path(cute_installation_id: @installation.id), class: "inline-flex items-center px-3 py-1.5 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700" do %>
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            Добавить новое
          <% end %>
        </div>
      </div>
      
      <% if @equipments.any? %>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead>
              <tr>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Тип</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Модель</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Инв. №</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Статус</th>
                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Действия</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              <% @equipments.each do |equipment| %>
                <tr class="hover:bg-gray-50">
                  <td class="px-4 py-2 text-sm text-gray-900">
                    <%= link_to equipment.equipment_type_text, cute_equipment_path(equipment), class: "text-blue-600 hover:text-blue-900" %>
                  </td>
                  <td class="px-4 py-2 text-sm text-gray-500"><%= equipment.equipment_model || "—" %></td>
                  <td class="px-4 py-2 text-sm text-gray-500"><%= equipment.inventory_number %></td>
                  <td class="px-4 py-2">
                    <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full <%= equipment.status_color %>">
                      <%= equipment.status_text %>
                    </span>
                  </td>
                  <td class="px-4 py-2 text-right">
                    <button type="button" 
                            onclick="unassignEquipment(<%= equipment.id %>)"
                            class="text-xs text-red-600 hover:text-red-900">
                      Отвязать
                    </button>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
        <% if @installation.equipment_count > 10 %>
          <div class="mt-4 text-center">
            <%= link_to "Показать всё оборудование (#{@installation.equipment_count})", cute_equipments_path(q: { cute_installation_id_eq: @installation.id }), class: "text-sm text-blue-600 hover:text-blue-500" %>
          </div>
        <% end %>
      <% else %>
        <div class="text-center py-6 text-gray-500">
          <p>На этом месте нет оборудования</p>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Modal для привязки оборудования -->
<div id="assignEquipmentModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
  <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
    <div class="mt-3">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-medium text-gray-900">Привязать оборудование</h3>
        <button type="button" onclick="closeAssignEquipmentModal()" class="text-gray-400 hover:text-gray-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">Выберите оборудование</label>
        <select id="unassignedEquipmentSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
          <option value="">Загрузка...</option>
        </select>
      </div>
      
      <div id="duplicateWarning" class="hidden mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-md">
        <div class="flex">
          <svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
          </svg>
          <div class="ml-3">
            <p class="text-sm text-yellow-700" id="duplicateWarningText"></p>
          </div>
        </div>
      </div>
      
      <div class="flex justify-end space-x-3">
        <button type="button" onclick="closeAssignEquipmentModal()" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
          Отмена
        </button>
        <button type="button" onclick="assignEquipment()" id="assignButton" class="px-4 py-2 border border-transparent rounded-md text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
          Привязать
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  const installationId = <%= @installation.id %>;
  let unassignedEquipments = [];
  
  function openAssignEquipmentModal() {
    document.getElementById('assignEquipmentModal').classList.remove('hidden');
    loadUnassignedEquipments();
  }
  
  function closeAssignEquipmentModal() {
    document.getElementById('assignEquipmentModal').classList.add('hidden');
    document.getElementById('duplicateWarning').classList.add('hidden');
  }
  
  function loadUnassignedEquipments() {
    const select = document.getElementById('unassignedEquipmentSelect');
    select.innerHTML = '<option value="">Загрузка...</option>';
    
    fetch('/cute_equipments.json?unassigned=true')
      .then(response => response.json())
      .then(data => {
        unassignedEquipments = data;
        select.innerHTML = '<option value="">Выберите оборудование</option>';
        data.forEach(eq => {
          const option = document.createElement('option');
          option.value = eq.id;
          option.textContent = `${eq.equipment_type_text} - ${eq.inventory_number}`;
          option.dataset.equipmentType = eq.equipment_type;
          select.appendChild(option);
        });
        
        // Add change handler for duplicate check
        select.addEventListener('change', checkForDuplicate);
      })
      .catch(error => {
        select.innerHTML = '<option value="">Ошибка загрузки</option>';
        console.error('Error loading equipments:', error);
      });
  }
  
  function checkForDuplicate() {
    const select = document.getElementById('unassignedEquipmentSelect');
    const warning = document.getElementById('duplicateWarning');
    const warningText = document.getElementById('duplicateWarningText');
    
    const selectedOption = select.options[select.selectedIndex];
    if (!selectedOption || !selectedOption.value) {
      warning.classList.add('hidden');
      return;
    }
    
    const equipmentType = selectedOption.dataset.equipmentType;
    
    fetch('/cute_equipments/check_duplicate', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify({
        equipment_type: equipmentType,
        installation_id: installationId
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.duplicate) {
        warningText.textContent = `Внимание: оборудование типа "${data.equipment.equipment_type}" уже привязано к этому месту (инв. №${data.equipment.inventory_number})`;
        warning.classList.remove('hidden');
      } else {
        warning.classList.add('hidden');
      }
    })
    .catch(error => {
      console.error('Error checking duplicate:', error);
    });
  }
  
  function assignEquipment() {
    const select = document.getElementById('unassignedEquipmentSelect');
    const equipmentId = select.value;
    
    if (!equipmentId) {
      alert('Выберите оборудование');
      return;
    }
    
    fetch(`/cute_equipments/${equipmentId}/assign_to_installation`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify({ installation_id: installationId })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert(data.errors.join(', '));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Ошибка при привязке оборудования');
    });
  }
  
  function unassignEquipment(equipmentId) {
    if (!confirm('Вы уверены, что хотите отвязать это оборудование?')) {
      return;
    }
    
    fetch(`/cute_equipments/${equipmentId}/unassign_from_installation`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert(data.errors.join(', '));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Ошибка при отвязке оборудования');
    });
  }
</script>
